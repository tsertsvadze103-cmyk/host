<!DOCTYPE ahtml>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>рЃџрЃљрЃўрЃЋ рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃАрЃўрЃЏрЃБрЃџрЃљрЃбрЃЮрЃарЃў</title>
    <!-- Tailwind CSS-рЃўрЃА рЃЕрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃљ рЃАрЃбрЃўрЃџрЃўрЃАрЃЌрЃЋрЃўрЃА -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter рЃцрЃЮрЃюрЃбрЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃљ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #4f46e5;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <header class="text-center mb-10 p-4 bg-white rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-gray-800">­Ъїљ рЃџрЃљрЃўрЃЋ рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃАрЃўрЃЏрЃБрЃџрЃљрЃбрЃЮрЃарЃў</h1>
            <p class="text-gray-500 mt-2">рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћрЃЌ 4-рЃфрЃўрЃцрЃарЃўрЃљрЃюрЃў рЃЎрЃЮрЃЊрЃў рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃЊрЃљрЃАрЃљрЃгрЃДрЃћрЃЉрЃљрЃЊ рЃљрЃю рЃАрЃљрЃюрЃљрЃ«рЃљрЃЋрЃљрЃЊ.</p>
        </header>

        <!-- рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃћрЃЉрЃў -->
        <div id="message-box" class="mb-6 p-4 rounded-lg text-sm hidden" role="alert"></div>

        <div class="grid md:grid-cols-2 gap-8">

            <!-- 1. рЃЏрЃЮрЃгрЃДрЃЮрЃЉрЃўрЃџрЃЮрЃЉрЃўрЃА рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃАрЃўрЃЏрЃБрЃџрЃљрЃбрЃЮрЃарЃў (Uploader) -->
            <div class="card bg-white p-6 rounded-xl border border-blue-100">
                <h2 class="text-2xl font-bold mb-4 text-blue-700">­ЪЊИ рЃЏрЃЮрЃгрЃДрЃЮрЃЉрЃўрЃџрЃЮрЃЉрЃљ: рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљ</h2>
                
                <div class="mb-4">
                    <label for="device-code-input" class="block text-gray-600 font-medium mb-1">4-рЃфрЃўрЃцрЃарЃўрЃљрЃюрЃў рЃЎрЃЮрЃЊрЃў (рЃЏрЃљрЃњ: 1010)</label>
                    <input type="text" id="device-code-input" maxlength="4" placeholder="рЃЕрЃљрЃгрЃћрЃарЃћрЃЌ рЃЎрЃЮрЃЊрЃў" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
                </div>
                
                <button id="start-stream-btn" class="w-full btn-primary text-white font-semibold py-3 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-150 ease-in-out">
                    рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљ (1 рЃгрЃљрЃЏрЃерЃў 1 рЃЎрЃљрЃЊрЃарЃў)
                </button>

                <p id="device-status" class="mt-4 text-sm font-semibold p-3 rounded-lg bg-gray-100 text-gray-600">
                    <span class="status-indicator bg-red-500" id="device-light"></span>
                    рЃАрЃбрЃљрЃбрЃБрЃАрЃў: рЃБрЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃЮ
                </p>

                <div class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-500 text-blue-700 text-sm rounded-lg">
                    <p>Рџа№ИЈ **рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃўрЃљ**: рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃў рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃЏрЃљрЃерЃўрЃю, рЃарЃЮрЃфрЃљ рЃћрЃА рЃњрЃЋрЃћрЃарЃЊрЃў рЃдрЃўрЃљрЃљ. рЃДрЃЮрЃЋрЃћрЃџ рЃгрЃљрЃЏрЃерЃў рЃ«рЃЊрЃћрЃЉрЃљ Firestore-рЃўрЃА рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃўрЃА рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃљ.</p>
                </div>
            </div>

            <!-- 2. рЃЏрЃюрЃљрЃ«рЃЋрЃћрЃџрЃў (Viewer) -->
            <div class="card bg-white p-6 rounded-xl border border-green-100">
                <h2 class="text-2xl font-bold mb-4 text-green-700">­ЪЊ║ рЃЏрЃюрЃљрЃ«рЃЋрЃћрЃџрЃў: рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃюрЃљрЃ«рЃЋрЃљ</h2>
                
                <div class="mb-4">
                    <label for="viewer-code-input" class="block text-gray-600 font-medium mb-1">4-рЃфрЃўрЃцрЃарЃўрЃљрЃюрЃў рЃЎрЃЮрЃЊрЃў</label>
                    <input type="text" id="viewer-code-input" maxlength="4" placeholder="рЃЕрЃљрЃгрЃћрЃарЃћрЃЌ рЃАрЃбрЃарЃўрЃЏрЃўрЃА рЃЎрЃЮрЃЊрЃў" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 text-lg">
                </div>
                
                <button id="view-stream-btn" class="w-full bg-green-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 transition duration-150 ease-in-out">
                    рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃюрЃљрЃ«рЃЋрЃљ
                </button>

                <div class="mt-6 border-t pt-4">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">рЃЏрЃўрЃЏрЃЊрЃўрЃюрЃљрЃарЃћ рЃЎрЃљрЃЊрЃарЃў:</h3>
                    <div id="image-container" class="w-full bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center aspect-video">
                        <img id="stream-image" src="https://placehold.co/600x400/CCCCCC/666666?text=рЃЊрЃљрЃћрЃџрЃЮрЃЊрЃћрЃЌ+рЃЎрЃљрЃЊрЃарЃА" alt="рЃџрЃљрЃўрЃЋ рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃЎрЃљрЃЊрЃарЃў" class="w-full h-full object-cover">
                    </div>
                    <p id="viewer-status" class="mt-3 text-sm font-medium text-gray-500 text-center">рЃЎрЃЮрЃЊрЃўрЃА рЃерЃћрЃДрЃЋрЃљрЃюрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ рЃЊрЃљрЃљрЃГрЃўрЃарЃћрЃЌ 'рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃюрЃљрЃ«рЃЋрЃљ'-рЃА.</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase SDK-рЃћрЃЉрЃўрЃА рЃўрЃЏрЃърЃЮрЃарЃбрЃў -->
    <script type="module">
        // Firebase-рЃўрЃА рЃАрЃљрЃГрЃўрЃарЃЮ рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃўрЃА рЃўрЃЏрЃърЃЮрЃарЃбрЃў. рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃБрЃџрЃўрЃљ 12.5.0 рЃЋрЃћрЃарЃАрЃўрЃўрЃЌ.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // --- Firebase рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ ---

        // Firebase-рЃўрЃА рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃў (рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃБрЃџрЃўрЃљ рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃџрЃўрЃА рЃЏрЃўрЃћрЃа рЃЏрЃЮрЃгрЃЮрЃЊрЃћрЃЉрЃБрЃџрЃў рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃўрЃЌ)
        const hardcodedConfig = {
            apiKey: "AIzaSyAB2FnGzm-vRFzjzMFc5fSqIx4JFhtSZHg",
            authDomain: "hostsite-87e89.firebaseapp.com",
            projectId: "hostsite-87e89",
            storageBucket: "hostsite-87e89.firebasestorage.app",
            messagingSenderId: "594577784773",
            appId: "1:594577784773:web:16b148cc0bc00999ebd5ac"
        };
        
        // рЃњрЃџрЃЮрЃЉрЃљрЃџрЃБрЃарЃў рЃфрЃЋрЃџрЃљрЃЊрЃћрЃЉрЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃљ, рЃЌрЃБ рЃ«рЃћрЃџрЃЏрЃўрЃАрЃљрЃгрЃЋрЃЊрЃЮрЃЏрЃўрЃљ, рЃгрЃўрЃюрЃљрЃљрЃдрЃЏрЃЊрЃћрЃњ рЃерЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃЋрЃљрЃерЃў hardcoded config-рЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃљ.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : hardcodedConfig;
        
        // App ID-рЃўрЃА рЃњрЃљрЃюрЃАрЃљрЃќрЃдрЃЋрЃарЃљ
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; 
        
        // рЃАрЃљрЃгрЃДрЃўрЃАрЃў рЃљрЃЋрЃЌрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃўрЃА рЃбрЃЮрЃЎрЃћрЃюрЃў
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let streamInterval = null; // рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃўрЃюрЃбрЃћрЃарЃЋрЃљрЃџрЃў
        let unsubscribeViewer = null; // рЃЏрЃюрЃљрЃ«рЃЋрЃћрЃџрЃўрЃА onSnapshot рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ
        let isAuthReady = false; // рЃљрЃЋрЃЌрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃўрЃА рЃАрЃбрЃљрЃбрЃБрЃАрЃў

        // --- UI рЃцрЃБрЃюрЃЦрЃфрЃўрЃћрЃЉрЃў ---

        // рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃћрЃЉрЃўрЃА рЃЕрЃЋрЃћрЃюрЃћрЃЉрЃљ UI-рЃќрЃћ
        function showMessage(text, isError = false) {
            const box = document.getElementById('message-box');
            box.textContent = text;
            box.className = 'mb-6 p-4 rounded-lg text-sm block font-medium';
            if (isError) {
                box.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-400', 'shadow-md');
            } else {
                box.classList.add('bg-blue-100', 'text-blue-700', 'border', 'border-blue-400', 'shadow-md');
            }
        }

        // --- Firebase рЃўрЃюрЃўрЃфрЃўрЃљрЃџрЃўрЃќрЃљрЃфрЃўрЃљ рЃЊрЃљ рЃљрЃЋрЃЌрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃљ ---

        async function initializeFirebase() {
            try {
                // 1. рЃўрЃюрЃўрЃфрЃўрЃљрЃџрЃўрЃќрЃљрЃфрЃўрЃљ
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                let authSuccess = false;

                // 2. рЃфрЃЊрЃљ рЃљрЃЋрЃЌрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃўрЃА рЃбрЃЮрЃЎрЃћрЃюрЃўрЃЌ (рЃЌрЃБ рЃЏрЃЮрЃгрЃЮрЃЊрЃћрЃЉрЃБрЃџрЃўрЃљ)
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        showMessage("РюЁ Firebase рЃљрЃЋрЃЌрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃљ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃљ (рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃџрЃўрЃА рЃбрЃЮрЃЎрЃћрЃюрЃўрЃЌ).");
                        authSuccess = true;
                    } catch (e) {
                        // рЃбрЃЮрЃЎрЃћрЃюрЃўрЃЌ рЃерЃћрЃАрЃЋрЃџрЃљ рЃЋрЃћрЃа рЃЏрЃЮрЃ«рЃћрЃарЃ«рЃЊрЃљ (рЃљрЃЦ рЃЋрЃўрЃдрЃћрЃЉрЃЌ 'auth/admin-restricted-operation' рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљрЃА)
                        console.error("Custom token sign-in failed:", e.message);
                        // рЃљрЃа рЃЋрЃБрЃерЃЋрЃћрЃЉрЃЌ рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџ рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљрЃА, рЃЋрЃфрЃЊрЃўрЃџрЃЮрЃЉрЃЌ рЃљрЃюрЃЮрЃюрЃўрЃЏрЃБрЃа рЃерЃћрЃАрЃЋрЃџрЃљрЃА
                        showMessage(`Рџа№ИЈ рЃбрЃЮрЃЎрЃћрЃюрЃўрЃЌ рЃерЃћрЃАрЃЋрЃџрЃљ рЃЋрЃћрЃа рЃЏрЃЮрЃ«рЃћрЃарЃ«рЃЊрЃљ: ${e.message}. рЃЋрЃћрЃфрЃЊрЃћрЃЉрЃўрЃЌ рЃљрЃюрЃЮрЃюрЃўрЃЏрЃБрЃа рЃерЃћрЃАрЃЋрЃџрЃљрЃА.`, true);
                    }
                }

                // 3. рЃЌрЃБ рЃљрЃа рЃЋрЃљрЃарЃЌ рЃерЃћрЃАрЃБрЃџрЃў (рЃљрЃю рЃбрЃЮрЃЎрЃћрЃюрЃўрЃЌ рЃерЃћрЃАрЃЋрЃџрЃљ рЃЕрЃљрЃЋрЃљрЃарЃЊрЃљ), рЃЋрЃфрЃЊрЃўрЃџрЃЮрЃЉрЃЌ рЃљрЃюрЃЮрЃюрЃўрЃЏрЃБрЃа рЃерЃћрЃАрЃЋрЃџрЃљрЃА
                if (!authSuccess) {
                    await signInAnonymously(auth);
                    showMessage("РюЁ Firebase рЃљрЃЋрЃЌрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃљ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃљ (рЃљрЃюрЃЮрЃюрЃўрЃЏрЃБрЃарЃљрЃЊ).");
                    authSuccess = true;
                }
                
                // 4. рЃАрЃљрЃЉрЃЮрЃџрЃЮрЃЮ рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ
                if (authSuccess && auth.currentUser) {
                     isAuthReady = true;
                } else {
                    throw new Error("Unable to sign in anonymously or with token.");
                }

            } catch (error) {
                // рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџрЃў рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ (рЃЏрЃљрЃњ., рЃўрЃюрЃўрЃфрЃўрЃљрЃџрЃўрЃќрЃљрЃфрЃўрЃўрЃА рЃљрЃю рЃљрЃюрЃЮрЃюрЃўрЃЏрЃБрЃарЃў рЃерЃћрЃАрЃЋрЃџрЃўрЃА рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ)
                console.error("Firebase-рЃўрЃА рЃўрЃюрЃўрЃфрЃўрЃљрЃџрЃўрЃќрЃљрЃфрЃўрЃўрЃА рЃљрЃю рЃљрЃЋрЃЌрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃўрЃА рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ:", error);
                showMessage(`РЮї Firebase-рЃўрЃА рЃўрЃюрЃўрЃфрЃўрЃљрЃџрЃўрЃќрЃљрЃфрЃўрЃўрЃА рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ: ${error.message}. рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЌ рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ.`, true);
                return; // рЃљрЃърЃџрЃўрЃЎрЃљрЃфрЃўрЃљ рЃЋрЃћрЃа рЃњрЃљрЃћрЃерЃЋрЃћрЃЉрЃљ рЃљрЃЋрЃЌрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃўрЃА рЃњрЃљрЃарЃћрЃерЃћ.
            }

            // --- рЃЎрЃЮрЃЊрЃўрЃА рЃЊрЃљрЃюрЃљрЃарЃЕрЃћрЃюрЃў рЃюрЃљрЃгрЃўрЃџрЃў (рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃЋрЃљрЃерЃў) ---
        }

        // --- рЃЏрЃЮрЃгрЃДрЃЮрЃЉрЃўрЃџрЃЮрЃЉрЃўрЃА рЃАрЃўрЃЏрЃБрЃџрЃљрЃбрЃЮрЃарЃўрЃА рЃџрЃЮрЃњрЃўрЃЎрЃљ (Uploader) ---

        document.getElementById('start-stream-btn').addEventListener('click', async () => {
            if (!isAuthReady) {
                showMessage("рЃњрЃЌрЃ«рЃЮрЃЋрЃЌ, рЃЊрЃљрЃћрЃџрЃЮрЃЊрЃЮрЃЌ Firebase-рЃўрЃА рЃўрЃюрЃўрЃфрЃўрЃљрЃџрЃўрЃќрЃљрЃфрЃўрЃљрЃА.", true);
                return;
            }

            const codeInput = document.getElementById('device-code-input');
            const code = codeInput.value.trim();
            const deviceStatus = document.getElementById('device-status');
            
            // рЃЋрЃљрЃџрЃўрЃЊрЃљрЃфрЃўрЃљ
            if (code.length !== 4 || !/^\d{4}$/.test(code)) {
                showMessage("РЮї рЃАрЃбрЃарЃўрЃЏрЃўрЃА рЃЎрЃЮрЃЊрЃў рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃќрЃБрЃАрЃбрЃљрЃЊ 4 рЃфрЃўрЃцрЃарЃў.", true);
                return;
            }
            
            // рЃЌрЃБ рЃБрЃЎрЃЋрЃћ рЃњрЃљрЃерЃЋрЃћрЃЉрЃБрЃџрЃўрЃљ, рЃерЃћрЃљрЃЕрЃћрЃарЃћ
            if (streamInterval) {
                clearInterval(streamInterval);
                streamInterval = null;
                deviceStatus.innerHTML = `<span class="status-indicator bg-red-500"></span> рЃАрЃбрЃљрЃбрЃБрЃАрЃў: рЃерЃћрЃЕрЃћрЃарЃћрЃЉрЃБрЃџрЃўрЃљ (рЃЎрЃЮрЃЊрЃў: ${code})`;
                document.getElementById('start-stream-btn').textContent = "рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљ (1 рЃгрЃљрЃЏрЃерЃў 1 рЃЎрЃљрЃЊрЃарЃў)";
                showMessage(`РюЁ рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃў рЃерЃћрЃЕрЃћрЃарЃћрЃЉрЃБрЃџрЃўрЃљ рЃЎрЃЮрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА ${code}.`, false);
                return;
            }
            
            // рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљ
            document.getElementById('start-stream-btn').textContent = "рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃўрЃА рЃерЃћрЃЕрЃћрЃарЃћрЃЉрЃљ";
            deviceStatus.innerHTML = `<span class="status-indicator bg-green-500"></span> рЃАрЃбрЃљрЃбрЃБрЃАрЃў: рЃљрЃЦрЃбрЃўрЃБрЃарЃў (рЃЎрЃЮрЃЊрЃў: ${code})`;
            showMessage(`­Ъџђ рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃў рЃЊрЃљрЃўрЃгрЃДрЃЮ рЃЎрЃЮрЃЊрЃўрЃЌ ${code}. Firestore рЃњрЃљрЃюрЃљрЃ«рЃџрЃЊрЃћрЃЉрЃљ рЃДрЃЮрЃЋрЃћрЃџ рЃгрЃљрЃЏрЃерЃў.`, false);

            // Firestore рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃўрЃА рЃЉрЃўрЃџрЃўрЃЎрЃў: /artifacts/{appId}/public/data/streams/{code}
            const streamDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'streams', code);

            const updateStream = async () => {
                const timestamp = Date.now();
                const imageColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                
                // рЃАрЃўрЃЏрЃБрЃџрЃўрЃарЃћрЃЉрЃБрЃџрЃў рЃљрЃ«рЃљрЃџрЃў рЃЎрЃљрЃЊрЃарЃў рЃБрЃюрЃўрЃЎрЃљрЃџрЃБрЃарЃў URL-рЃўрЃЌ
                const imageUrl = `https://placehold.co/600x400/${imageColor.slice(1)}/ffffff?text=${code}_${new Date().toLocaleTimeString('ka-GE')}`;

                try {
                    // рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃЌрЃљ рЃЕрЃљрЃгрЃћрЃарЃљ, рЃФрЃЋрЃћрЃџрЃўрЃА рЃњрЃљрЃЊрЃљрЃгрЃћрЃарЃљ
                    await setDoc(streamDocRef, {
                        imageUrl: imageUrl,
                        timestamp: timestamp,
                        deviceId: code,
                        uploaderUserId: auth.currentUser.uid
                    }, { merge: true });
                } catch (e) {
                    console.error("Firestore-рЃўрЃА рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ:", e);
                    showMessage(`РЮї рЃЎрЃљрЃЊрЃарЃўрЃА рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ: ${e.message}`, true);
                    clearInterval(streamInterval);
                    streamInterval = null;
                    deviceStatus.innerHTML = `<span class="status-indicator bg-red-500"></span> рЃАрЃбрЃљрЃбрЃБрЃАрЃў: рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ`;
                }
            };

            // рЃЊрЃљрЃБрЃДрЃЮрЃЋрЃюрЃћрЃЉрЃџрЃўрЃЋ рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃљ рЃЊрЃљ рЃерЃћрЃЏрЃЊрЃћрЃњ рЃўрЃюрЃбрЃћрЃарЃЋрЃљрЃџрЃўрЃА рЃЊрЃљрЃДрЃћрЃюрЃћрЃЉрЃљ
            await updateStream();
            streamInterval = setInterval(updateStream, 1000); // рЃДрЃЮрЃЋрЃћрЃџ 1 рЃгрЃљрЃЏрЃерЃў
        });

        // --- рЃЏрЃюрЃљрЃ«рЃЋрЃћрЃџрЃўрЃА рЃџрЃЮрЃњрЃўрЃЎрЃљ (Viewer) ---

        document.getElementById('view-stream-btn').addEventListener('click', () => {
            if (!isAuthReady) {
                showMessage("рЃњрЃЌрЃ«рЃЮрЃЋрЃЌ, рЃЊрЃљрЃћрЃџрЃЮрЃЊрЃЮрЃЌ Firebase-рЃўрЃА рЃўрЃюрЃўрЃфрЃўрЃљрЃџрЃўрЃќрЃљрЃфрЃўрЃљрЃА.", true);
                return;
            }

            const codeInput = document.getElementById('viewer-code-input');
            const code = codeInput.value.trim();
            const streamImage = document.getElementById('stream-image');
            const viewerStatus = document.getElementById('viewer-status');

            // рЃЋрЃљрЃџрЃўрЃЊрЃљрЃфрЃўрЃљ
            if (code.length !== 4 || !/^\d{4}$/.test(code)) {
                showMessage("РЮї рЃЎрЃЮрЃЊрЃў рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃќрЃБрЃАрЃбрЃљрЃЊ 4 рЃфрЃўрЃцрЃарЃў.", true);
                return;
            }

            // рЃгрЃўрЃюрЃљ onSnapshot-рЃўрЃА рЃњрЃљрЃБрЃЦрЃЏрЃћрЃЉрЃљ
            if (unsubscribeViewer) {
                unsubscribeViewer();
                viewerStatus.textContent = `рЃгрЃўрЃюрЃљ рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃў рЃерЃћрЃЕрЃћрЃарЃЊрЃљ.`;
                streamImage.src = 'https://placehold.co/600x400/CCCCCC/666666?text=рЃЊрЃљрЃћрЃџрЃЮрЃЊрЃћрЃЌ+рЃЎрЃљрЃЊрЃарЃА';
            }

            // Firestore рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃўрЃА рЃЉрЃўрЃџрЃўрЃЎрЃў
            const streamDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'streams', code);

            // onSnapshot-рЃўрЃА рЃЊрЃљрЃДрЃћрЃюрЃћрЃЉрЃљ рЃарЃћрЃљрЃџрЃБрЃа рЃЊрЃарЃЮрЃерЃў рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃўрЃА рЃЏрЃўрЃАрЃљрЃдрЃћрЃЉрЃљрЃЊ
            unsubscribeViewer = onSnapshot(streamDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    if (data && data.imageUrl) {
                        // рЃАрЃБрЃарЃљрЃЌрЃўрЃА рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃљ
                        streamImage.src = data.imageUrl;
                        viewerStatus.textContent = `РюЁ рЃАрЃбрЃарЃўрЃЏрЃў рЃЎрЃЮрЃЊрЃўрЃЌ ${code} рЃљрЃЦрЃбрЃўрЃБрЃарЃўрЃљ. рЃЉрЃЮрЃџрЃЮ рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃљ: ${new Date(data.timestamp).toLocaleTimeString('ka-GE')}`;
                    } else {
                        viewerStatus.textContent = `Рџа№ИЈ рЃАрЃбрЃарЃўрЃЏрЃў ${code} рЃюрЃљрЃърЃЮрЃЋрЃюрЃўрЃљ, рЃЏрЃљрЃњрЃарЃљрЃЏ рЃЎрЃљрЃЊрЃарЃўрЃА рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃў рЃфрЃљрЃарЃўрЃћрЃџрЃўрЃљ.`;
                    }
                } else {
                    // рЃЌрЃБ рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃў рЃљрЃа рЃљрЃарЃАрЃћрЃЉрЃЮрЃЉрЃА (рЃАрЃбрЃарЃўрЃЏрЃў рЃљрЃа рЃљрЃарЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃБрЃџрЃў)
                    streamImage.src = 'https://placehold.co/600x400/CC0000/FFFFFF?text=рЃАрЃбрЃарЃўрЃЏрЃў+рЃљрЃа+рЃЏрЃЮрЃўрЃФрЃћрЃЉрЃюрЃљ';
                    viewerStatus.textContent = `РЮї рЃАрЃбрЃарЃўрЃЏрЃў рЃЎрЃЮрЃЊрЃўрЃЌ ${code} рЃљрЃа рЃљрЃарЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃБрЃџрЃў.`;
                }
            }, (error) => {
                console.error("onSnapshot-рЃўрЃА рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ:", error);
                showMessage(`РЮї рЃАрЃбрЃарЃўрЃЏрЃўрЃА рЃЊрЃљрЃЎрЃљрЃЋрЃерЃўрЃарЃћрЃЉрЃўрЃА рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ: ${error.message}`, true);
                viewerStatus.textContent = `РЮї рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ рЃАрЃбрЃарЃўрЃЏрЃўрЃА рЃЊрЃљрЃЎрЃљрЃЋрЃерЃўрЃарЃћрЃЉрЃўрЃАрЃљрЃА.`;
                if (unsubscribeViewer) unsubscribeViewer();
            });

            showMessage(`­ЪЉђ рЃАрЃбрЃарЃўрЃЏрЃўрЃюрЃњрЃќрЃћ рЃЊрЃљрЃЎрЃљрЃЋрЃерЃўрЃарЃћрЃЉрЃљ рЃЎрЃЮрЃЊрЃўрЃЌ ${code}...`, false);
        });

        // рЃљрЃърЃџрЃўрЃЎрЃљрЃфрЃўрЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљ
        initializeFirebase();

    </script>
</body>
</html>
